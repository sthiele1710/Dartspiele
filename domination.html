
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Domination</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WG Darts">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    body { 
        margin:0; 
        font-family: system-ui, sans-serif; 
        background:#1a1a1a; 
        color:white; 
        text-align:center; 
        overflow-x: hidden;
        touch-action: manipulation; 
        padding-bottom: 20px; 
    }

    /* NEU: Das Overlay f√ºr den Rand - Liegt FEST √ºber dem Bildschirm */
    #game-border {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Wichtig: L√§sst Klicks durch! */
        z-index: 9999; /* Ganz oben */
        box-sizing: border-box;
        border: 0px solid transparent;
        transition: box-shadow 0.8s ease-in-out, border-color 0.8s ease-in-out;
    }

    /* Die Klassen f√ºr das Overlay */
    #game-border.turn-p1 {
        box-shadow: inset 0 0 50px rgba(255, 59, 59, 0.4); 
        border: 4px solid rgba(255, 59, 59, 0.5); 
    }
    #game-border.turn-p2 {
        box-shadow: inset 0 0 50px rgba(0, 191, 255, 0.4);
        border: 4px solid rgba(0, 191, 255, 0.5);
    }
    #game-border.winner-glow {
        box-shadow: inset 0 0 80px rgba(255, 215, 0, 0.6);
        border: 6px solid gold;
    }

    h1 {margin:15px 0 5px 0; font-size:24px; color: gold;}
    
    /* NEU: Info f√ºr Serienstand */
    #seriesInfo { font-size: 14px; color: #888; margin-bottom: 10px; font-weight: bold; }

    #top { display:flex; justify-content:space-between; padding:0 15px; font-size:18px; max-width:440px; margin:auto; }
    .p1 { color:#ff3b3b; font-weight:bold; }
    .p2 { color:#00bfff; font-weight:bold; }
    #throws { font-size:18px; margin:8px 0; background: #333; display: inline-block; padding: 4px 15px; border-radius: 20px;}
    
    #controls { max-width:440px; margin:auto; padding: 0 10px; }
    .btn-row { display:flex; justify-content:center; gap:6px; margin-bottom:8px; }
    
    button { padding:12px; font-size:14px; border-radius:6px; border:none; cursor:pointer; flex:1; background: #444; color: white; transition: 0.2s; user-select: none; }
    button.active { background: gold; color: black; font-weight:bold; transform: scale(1.05);}
    button.func { background: #555; }
    
    #next-turn-container { max-width:440px; margin: 10px auto; padding: 0 10px; }
    button.next-turn { background: #2e7d32; color: white; width: 100%; font-weight: bold; font-size: 16px; border: 1px solid #4caf50; padding: 15px; border-radius: 8px;}
    
    #dartboard { width:100vw; max-width:480px; height:auto; display:block; margin:auto; touch-action: none; }
    #winner { font-size:28px; margin:15px 0; font-weight:bold; color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.5);}
    
    .numberLabel { font-weight:bold; pointer-events:none; fill: #666; font-size: 13px; }
    .owned-1 { fill: #ff3b3b !important; font-size: 20px; filter: drop-shadow(0px 0px 3px black); }
    .owned-2 { fill: #00bfff !important; font-size: 20px; filter: drop-shadow(0px 0px 3px black); }
    .hitBadge { pointer-events: none; }
    .hitText { fill: white; font-size: 11px; font-weight: bold; text-anchor: middle; dominant-baseline: central; }
</style>
</head>
<body>

<div id="game-border"></div>

<h1>üéØ Domination</h1>
<div id="seriesInfo"></div>

<div id="top">
  <span id="s1" class="p1">Spieler 1: 0</span>
  <span id="s2" class="p2">Spieler 2: 0</span>
</div>
<div id="throws">W√ºrfe: 3</div>

<div id="controls">
  <div class="btn-row">
    <button id="single" class="active" onclick="setMulti(1)">Single</button>
    <button id="double" onclick="setMulti(2)">Double</button>
    <button id="triple" onclick="setMulti(3)">Triple</button>
  </div>
  <div class="btn-row">
    <button class="func" onclick="undo()">‚Ü©Ô∏è Undo</button>
    <button class="func" onclick="confirmReset()">üîÑ Reset</button>
    <button class="func" id="homeBtn" onclick="location.href='index.html'">üè† Home</button>
  </div>
</div>

<div id="winner"></div>

<svg viewBox="-240 -240 480 480" id="dartboard">
    <defs>
        <pattern id="hatch" patternUnits="userSpaceOnUse" width="10" height="10" patternTransform="rotate(45)">
            <rect width="5" height="10" fill="rgba(255,59,59,0.7)" />
            <rect x="5" width="5" height="10" fill="rgba(0,191,255,0.7)" />
        </pattern>
    </defs>
</svg>

<div id="next-turn-container">
    <button class="next-turn" onclick="nextTurn()">‚è≠Ô∏è Zug beenden / Verfehlt</button>
</div>

<script>
// --- TURNIER LOGIK START ---
const urlParams = new URLSearchParams(window.location.search);
const isTournament = urlParams.get('tournament') === 'true';

let name1, name2;

if (isTournament) {
    // Namen aus dem Turnierspeicher laden
    name1 = localStorage.getItem('tournament_p1') || "T-Spieler 1";
    name2 = localStorage.getItem('tournament_p2') || "T-Spieler 2";
    // Home Button ausblenden
    const btn = document.getElementById('homeBtn');
    if(btn) btn.style.display = 'none';

    // Serienstand anzeigen? (Best of Modus)
    let s1 = urlParams.get('s1');
    let s2 = urlParams.get('s2');
    let target = urlParams.get('target');
    if(s1 !== null) {
        document.getElementById('seriesInfo').innerHTML = `Serie: <span style="color:#ff3b3b">${s1}</span> - <span style="color:#00bfff">${s2}</span> (First to ${target})`;
    }
} else {
    // Normale Namen
    name1 = localStorage.getItem('dart_p1') || "Spieler 1";
    name2 = localStorage.getItem('dart_p2') || "Spieler 2";
}
// --- TURNIER LOGIK ENDE ---

const order=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
const ROTATION_OFFSET = -9;
const BOARD_R = 180;
const BULL_R = 38;

let hits={}, owner={}, history=[];
let currentPlayer=1, throwsLeft=3, multiplier=1, gameOver=false;

function initData(){
    hits={}; owner={}; 
    [...order, 25].forEach(n => {
        hits[n] = {1:0, 2:0};
        owner[n] = 0;
    });
}

function snapshot(){
    history.push(JSON.stringify({hits, owner, currentPlayer, throwsLeft, multiplier, gameOver}));
}

function nextTurn() {
    if(gameOver) return;
    snapshot();
    currentPlayer = currentPlayer === 1 ? 2 : 1;
    throwsLeft = 3;
    multiplier = 1;
    setMulti(1);
    updateUI();
    drawBoard();
}

function undo(){
    if(!history.length) return;
    const s = JSON.parse(history.pop());
    hits=s.hits; owner=s.owner; currentPlayer=s.currentPlayer;
    throwsLeft=s.throwsLeft; multiplier=s.multiplier; gameOver=s.gameOver;
    updateUI(); drawBoard();
}

function setMulti(m){
    if(gameOver) return;
    multiplier=m;
    ["single","double","triple"].forEach(id=>document.getElementById(id).classList.remove("active"));
    const btn = document.getElementById(m===1?"single":m===2?"double":"triple");
    if(btn) btn.classList.add("active");
}

function throwDart(num){
    if(gameOver) return;
    if(multiplier===3 && num===25) return; 
    
    if(navigator.vibrate) navigator.vibrate(30);

    snapshot();
    hits[num][currentPlayer] += multiplier;
    updateOwner(num);
    throwsLeft--;
    if(throwsLeft === 0){ currentPlayer = currentPlayer === 1 ? 2 : 1; throwsLeft = 3; }
    multiplier = 1; setMulti(1);
    updateUI(); drawBoard();
    checkWin();
}

function updateOwner(z){
    const a = hits[z][1], b = hits[z][2];
    if(a >= 3 || b >= 3){
        if(a > b) owner[z] = 1; else if(b > a) owner[z] = 2; else owner[z] = 3; 
    }
}

function checkWin(){
    let p1 = Object.values(owner).filter(o => o === 1).length;
    let p2 = Object.values(owner).filter(o => o === 2).length;
    
    if(p1 >= 11 || p2 >= 11) {
        let winnerName = (p1 >= 11) ? name1 : name2;
        document.getElementById("winner").textContent = `üèÜ ${winnerName} GEWINNT!`;
        gameOver = true;

        // NEU: Glow auf Overlay setzen
        document.getElementById('game-border').className = "winner-glow";
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

        // HIER WURDE GE√ÑNDERT: Stats speichern AUCH im Turnier!
        saveWin(winnerName);

        // --- TURNIER LOGIK (NEU) ---
        if(isTournament) {
            localStorage.setItem('tournament_winner_name', winnerName);
            setTimeout(() => {
                window.location.href = "tournament.html";
            }, 3000);
            return; // Beenden, damit es nicht in die normale Statistik flie√üt
        }
    }
}

// NEUE Funktion zum Speichern (zentralisiert)
function saveWin(winnerName) {
    let stats = JSON.parse(localStorage.getItem('allTimeStats') || '{}');
    if (!stats[winnerName]) stats[winnerName] = { dart: 0, ttt: 0, x01: 0 };
    if (typeof stats[winnerName] === 'number') stats[winnerName] = { dart: stats[winnerName], ttt: 0, x01: 0 };
    stats[winnerName].dart = (stats[winnerName].dart || 0) + 1;
    localStorage.setItem('allTimeStats', JSON.stringify(stats));
}

function updateUI(){
    const p1Count = Object.values(owner).filter(o => o === 1).length;
    const p2Count = Object.values(owner).filter(o => o === 2).length;
    document.getElementById("s1").textContent = `${name1}: ${p1Count}`;
    document.getElementById("s2").textContent = `${name2}: ${p2Count}`;
    document.getElementById("s1").style.opacity = currentPlayer === 1 ? "1" : "0.3";
    document.getElementById("s2").style.opacity = currentPlayer === 2 ? "1" : "0.3";
    document.getElementById("throws").textContent = "W√ºrfe: " + throwsLeft;

    // NEU: Glow auf Overlay setzen (nicht Body)
    if(!gameOver) {
        document.getElementById('game-border').className = (currentPlayer === 1) ? "turn-p1" : "turn-p2";
    }
}

function drawBadge(svg, x, y, val, color) {
    const circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
    circ.setAttribute("cx", x); circ.setAttribute("cy", y); circ.setAttribute("r", "9");
    circ.setAttribute("fill", color); circ.setAttribute("stroke", "white");
    circ.classList.add("hitBadge");
    svg.appendChild(circ);

    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x", x); t.setAttribute("y", y);
    t.classList.add("hitText"); t.textContent = val;
    svg.appendChild(t);
}

function drawBoard(){
    const svg = document.getElementById("dartboard");
    const defs = svg.querySelector("defs");
    svg.innerHTML = "";
    svg.appendChild(defs);

    order.forEach((n, i) => {
        const a1 = ((i * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const a2 = (((i + 1) * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const x1=BOARD_R*Math.cos(a1), y1=BOARD_R*Math.sin(a1), x2=BOARD_R*Math.cos(a2), y2=BOARD_R*Math.sin(a2);
        const bg = document.createElementNS("http://www.w3.org/2000/svg","path");
        bg.setAttribute("d",`M0,0 L${x1},${y1} A${BOARD_R},${BOARD_R} 0 0,1 ${x2},${y2} Z`);
        bg.setAttribute("fill","#2a2a2a"); bg.setAttribute("stroke","#000");
        svg.appendChild(bg);

        let h1 = hits[n][1], h2 = hits[n][2];
        let maxVal = Math.max(3, h1, h2);
        if(h1 === h2 && h1 > 0) {
            const r = BULL_R + (BOARD_R - BULL_R) * (h1 / maxVal);
            const path = document.createElementNS("http://www.w3.org/2000/svg","path");
            path.setAttribute("d",`M0,0 L${r*Math.cos(a1)},${r*Math.sin(a1)} A${r},${r} 0 0,1 ${r*Math.cos(a2)},${r*Math.sin(a2)} Z`);
            path.setAttribute("fill", "url(#hatch)");
            svg.appendChild(path);
        } else {
            let pData = [{id:1, h:h1}, {id:2, h:h2}].sort((a,b) => b.h - a.h);
            pData.forEach(p => {
                if(p.h > 0) {
                    const r = BULL_R + (BOARD_R - BULL_R) * (p.h / maxVal);
                    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
                    path.setAttribute("d",`M0,0 L${r*Math.cos(a1)},${r*Math.sin(a1)} A${r},${r} 0 0,1 ${r*Math.cos(a2)},${r*Math.sin(a2)} Z`);
                    path.setAttribute("fill", p.id === 1 ? "rgba(255,59,59,0.8)" : "rgba(0,191,255,0.8)");
                    svg.appendChild(path);
                }
            });
        }
    });

    const b1 = hits[25][1], b2 = hits[25][2];
    const maxB = Math.max(3, b1, b2);
    const bBg = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bBg.setAttribute("r", BULL_R); bBg.setAttribute("fill", "#2a2a2a"); bBg.setAttribute("stroke","#000"); svg.appendChild(bBg);
    if(b1 > 0 || b2 > 0) {
        const rMax = BULL_R * (Math.max(b1, b2) / maxB);
        const circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
        circ.setAttribute("r", rMax);
        circ.setAttribute("fill", b1 === b2 ? "url(#hatch)" : (b1 > b2 ? "rgba(255,59,59,0.9)" : "rgba(0,191,255,0.9)"));
        svg.appendChild(circ);
        if(b1 !== b2 && b1 > 0 && b2 > 0) {
            const rMin = BULL_R * (Math.min(b1, b2) / maxB);
            const circMin = document.createElementNS("http://www.w3.org/2000/svg","circle");
            circMin.setAttribute("r", rMin);
            circMin.setAttribute("fill", b1 < b2 ? "rgba(255,59,59,1)" : "rgba(0,191,255,1)");
            svg.appendChild(circMin);
        }
    }

    order.forEach((n, i) => {
        const a1 = ((i * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const a2 = (((i + 1) * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const mid = (a1 + a2) / 2;
        const h1 = hits[n][1], h2 = hits[n][2];
        const maxVal = Math.max(3, h1, h2);
        if(h1 === h2 && h1 > 0) {
            const rEnd = BULL_R + (BOARD_R - BULL_R) * (h1 / maxVal);
            const labelR = BULL_R + (rEnd - BULL_R) / 2;
            drawBadge(svg, labelR * Math.cos(mid), labelR * Math.sin(mid), h1, "#666");
        } else {
            let pData = [{id:1, h:h1}, {id:2, h:h2}].sort((a,b) => a.h - b.h);
            let currentInnerR = BULL_R;
            pData.forEach(p => {
                if(p.h > 0) {
                    const rEnd = BULL_R + (BOARD_R - BULL_R) * (p.h / maxVal);
                    const labelR = currentInnerR + (rEnd - currentInnerR) / 2;
                    drawBadge(svg, labelR * Math.cos(mid), labelR * Math.sin(mid), p.h, p.id === 1 ? "#ff3b3b" : "#00bfff");
                    currentInnerR = rEnd;
                }
            });
        }
        const lx = (BOARD_R + 35) * Math.cos(mid), ly = (BOARD_R + 35) * Math.sin(mid);
        const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
        txt.setAttribute("x", lx); txt.setAttribute("y", ly);
        txt.setAttribute("class", "numberLabel" + (owner[n]===1?" owned-1":owner[n]===2?" owned-2":""));
        txt.setAttribute("text-anchor","middle"); txt.setAttribute("alignment-baseline","middle");
        txt.textContent = n; svg.appendChild(txt);
        const click = document.createElementNS("http://www.w3.org/2000/svg","path");
        const x1=BOARD_R*Math.cos(a1), y1=BOARD_R*Math.sin(a1), x2=BOARD_R*Math.cos(a2), y2=BOARD_R*Math.sin(a2);
        click.setAttribute("d",`M0,0 L${x1},${y1} A${BOARD_R},${BOARD_R} 0 0,1 ${x2},${y2} Z`);
        click.setAttribute("fill","transparent"); click.style.cursor="pointer";
        click.onclick = () => throwDart(n); svg.appendChild(click);
    });

    const b1 = hits[25][1], b2 = hits[25][2];
    const maxB = Math.max(3, b1, b2);
    const bBg = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bBg.setAttribute("r", BULL_R); bBg.setAttribute("fill", "#2a2a2a"); bBg.setAttribute("stroke","#000"); svg.appendChild(bBg);
    if(b1 > 0 || b2 > 0) {
        const rMax = BULL_R * (Math.max(b1, b2) / maxB);
        const circ = document.createElementNS("http://www.w3.org/2000/svg","circle");
        circ.setAttribute("r", rMax);
        circ.setAttribute("fill", b1 === b2 ? "url(#hatch)" : (b1 > b2 ? "rgba(255,59,59,0.9)" : "rgba(0,191,255,0.9)"));
        svg.appendChild(circ);
        if(b1 !== b2 && b1 > 0 && b2 > 0) {
            const rMin = BULL_R * (Math.min(b1, b2) / maxB);
            const circMin = document.createElementNS("http://www.w3.org/2000/svg","circle");
            circMin.setAttribute("r", rMin);
            circMin.setAttribute("fill", b1 < b2 ? "rgba(255,59,59,1)" : "rgba(0,191,255,1)");
            svg.appendChild(circMin);
        }
    }
    const bClick = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bClick.setAttribute("r", BULL_R); bClick.setAttribute("fill","transparent");
    bClick.style.cursor="pointer"; bClick.onclick = () => throwDart(25);
    svg.appendChild(bClick);
}

function confirmReset() {
    if (confirm("Reset?")) {
        resetGame();
    }
}

function resetGame(){
    initData(); currentPlayer = 1; throwsLeft = 3; multiplier = 1; gameOver = false;
    history = []; document.getElementById("winner").textContent = ""; 
    setMulti(1); updateUI(); drawBoard();
}

async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try {
      await navigator.wakeLock.request('screen');
    } catch (err) { console.log(err); }
  }
}
document.addEventListener('click', requestWakeLock, { once: true });

initData();
updateUI();
drawBoard();
</script>
</body>
</html>
