<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cricket Darts</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    body { 
        margin:0; font-family: system-ui, sans-serif; background:#1a1a1a; color:white; text-align:center; 
        overflow: hidden; touch-action: manipulation; padding-bottom: 0; 
        height: 100vh; display: flex; flex-direction: column;
    }

    #game-border {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
        box-sizing: border-box; border: 0px solid transparent; transition: box-shadow 0.8s ease-in-out, border-color 0.8s ease-in-out;
    }
    #game-border.turn-p1 { box-shadow: inset 0 0 50px rgba(255, 59, 59, 0.4); border: 4px solid rgba(255, 59, 59, 0.5); }
    #game-border.turn-p2 { box-shadow: inset 0 0 50px rgba(0, 191, 255, 0.4); border: 4px solid rgba(0, 191, 255, 0.5); }
    #game-border.winner-glow { box-shadow: inset 0 0 80px rgba(255, 215, 0, 0.6); border: 6px solid gold; }

    /* --- HEADER --- */
    .top-bar { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; margin-bottom: 5px; flex-shrink: 0; }
    h1 { margin: 0; color: gold; font-size: 22px; line-height: 1; }
    #seriesInfo { font-size: 14px; color: #888; font-weight: bold; margin-top: 2px; flex-shrink: 0;}
    #roundDisplay { font-size: 16px; color: #aaa; font-weight: bold; margin-bottom: 5px; flex-shrink: 0;}

    /* --- CRICKET SCOREBOARD --- */
    .cricket-board {
        display: flex; justify-content: center; width: 100%; max-width: 400px; margin: 0 auto 5px auto;
        font-weight: bold; font-size: 18px;
    }
    .c-col { display: flex; flex-direction: column; gap: 2px; }
    .c-center { width: 50px; margin: 0 5px; }
    .c-side { flex: 1; background: #222; border-radius: 8px; padding: 5px; transition: 0.3s; }
    
    .c-side.active { border: 2px solid gold; background: #333; }
    .p1-side .c-name { color: #ff3b3b; font-size: 14px; margin-bottom: 5px; }
    .p2-side .c-name { color: #00bfff; font-size: 14px; margin-bottom: 5px; }

    .c-row { display: flex; align-items: center; justify-content: center; height: 28px; }
    
    /* Die Symbole */
    .mark { font-family: monospace; font-size: 20px; color: #555; }
    .mark.s1 { color: #fff; } /* / */
    .mark.s2 { color: #fff; } /* X */
    .mark.s3 { color: gold; text-shadow: 0 0 3px gold; } /* O (Closed) */
    
    .num-label { color: #888; font-size: 16px; }
    .score-total { font-size: 24px; margin-top: 5px; border-top: 1px solid #444; padding-top: 2px; color: white;}

    /* --- CONTROLS --- */
    #controls { max-width:440px; margin: 0 auto; padding: 0 10px; width: 100%; box-sizing: border-box; flex-shrink: 0; }
    .btn-row { display:flex; justify-content:center; gap:8px; margin-bottom:10px; }
    button { padding: 12px; font-size:15px; border-radius:8px; border:none; cursor:pointer; flex:1; background: #444; color: white; transition: 0.1s; user-select: none; }
    button.active { background: gold; color: black; font-weight:bold; }
    button.func { background: #555; padding: 10px; font-size: 13px; }
    
    /* --- BOARD --- */
    #board-container { 
        flex: 1; display: flex; align-items: center; justify-content: center; 
        width: 100%; overflow: hidden; margin-bottom: 5px;
    }
    #dartboard { width: 100%; height: 100%; max-width: 100%; max-height: 100%; display: block; }
    
    /* Dimmen nicht ben√∂tigter Felder */
    .dimmed { opacity: 0.15; }

    #next-turn-container { width: 100%; max-width:440px; margin: 0 auto 10px auto; padding: 0 10px; box-sizing: border-box; flex-shrink: 0; }
    button.next-turn { background: #2e7d32; color: white; width: 100%; font-weight: bold; font-size: 18px; border: 1px solid #4caf50; padding: 15px; border-radius: 10px;}
    
    #winner { font-size:32px; margin:15px 0; font-weight:bold; color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.5); position:absolute; top: 40%; left:0; width:100%; z-index:100; pointer-events:none;}
</style>
</head>
<body>

<div id="game-border"></div>

<div class="top-bar">
    <h1 id="mainTitle">ü¶ó Cricket</h1>
</div>
<div id="seriesInfo"></div>
<div id="roundDisplay">Runde: 1</div>

<div class="cricket-board">
    <div class="c-col c-side p1-side" id="p1-side">
        <div class="c-name" id="name1">Spieler 1</div>
        <div class="c-row mark" id="p1-20"></div>
        <div class="c-row mark" id="p1-19"></div>
        <div class="c-row mark" id="p1-18"></div>
        <div class="c-row mark" id="p1-17"></div>
        <div class="c-row mark" id="p1-16"></div>
        <div class="c-row mark" id="p1-15"></div>
        <div class="c-row mark" id="p1-25"></div>
        <div class="score-total" id="score1">0</div>
    </div>

    <div class="c-col c-center">
        <div class="c-name">&nbsp;</div> <div class="c-row num-label">20</div>
        <div class="c-row num-label">19</div>
        <div class="c-row num-label">18</div>
        <div class="c-row num-label">17</div>
        <div class="c-row num-label">16</div>
        <div class="c-row num-label">15</div>
        <div class="c-row num-label">B</div>
        <div class="score-total" style="opacity:0">0</div>
    </div>

    <div class="c-col c-side p2-side" id="p2-side">
        <div class="c-name" id="name2">Spieler 2</div>
        <div class="c-row mark" id="p2-20"></div>
        <div class="c-row mark" id="p2-19"></div>
        <div class="c-row mark" id="p2-18"></div>
        <div class="c-row mark" id="p2-17"></div>
        <div class="c-row mark" id="p2-16"></div>
        <div class="c-row mark" id="p2-15"></div>
        <div class="c-row mark" id="p2-25"></div>
        <div class="score-total" id="score2">0</div>
    </div>
</div>

<div id="controls">
  <div class="btn-row">
    <button id="single" class="active" onclick="setMulti(1)">Single</button>
    <button id="double" onclick="setMulti(2)">Double</button>
    <button id="triple" onclick="setMulti(3)">Triple</button>
  </div>
  <div class="btn-row">
    <button class="func" onclick="undo()">‚Ü©Ô∏è Undo</button>
    <button class="func" onclick="confirmReset()">üîÑ Reset</button>
    <button class="func" id="homeBtn" onclick="location.href='index.html'">üè† Home</button>
  </div>
</div>

<div id="winner"></div>

<div id="board-container">
    <svg viewBox="-225 -225 450 450" id="dartboard">
        <defs><pattern id="hatch" patternUnits="userSpaceOnUse" width="10" height="10" patternTransform="rotate(45)"><rect width="5" height="10" fill="rgba(255,59,59,0.7)" /><rect x="5" width="5" height="10" fill="rgba(0,191,255,0.7)" /></pattern></defs>
    </svg>
</div>

<div id="next-turn-container">
    <button class="next-turn" onclick="nextTurn()">‚è≠Ô∏è Zug beenden / Verfehlt</button>
</div>

<script>
// --- CONFIG & SETUP ---
const cricketNums = [20, 19, 18, 17, 16, 15, 25];
const order=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
const ROTATION_OFFSET = -9;
const BOARD_R = 180;
const BULL_R = 38;

const urlParams = new URLSearchParams(window.location.search);
const isTournament = urlParams.get('tournament') === 'true';
const startParam = urlParams.get('starter');
const initialPlayer = startParam ? parseInt(startParam) : 1;

let name1, name2;
if (isTournament) {
    name1 = localStorage.getItem('tournament_p1') || "T1";
    name2 = localStorage.getItem('tournament_p2') || "T2";
    document.getElementById('homeBtn').style.display = 'none';
    let s1 = urlParams.get('s1');
    let s2 = urlParams.get('s2');
    let target = urlParams.get('target');
    if(s1 !== null) {
        document.getElementById('seriesInfo').innerHTML = `Serie: <span style="color:#ff3b3b">${s1}</span> - <span style="color:#00bfff">${s2}</span> (First to ${target})`;
    }
} else {
    name1 = localStorage.getItem('dart_p1') || "Spieler 1";
    name2 = localStorage.getItem('dart_p2') || "Spieler 2";
}

document.getElementById('name1').textContent = name1;
document.getElementById('name2').textContent = name2;

// --- GAME STATE ---
let scores = {1: 0, 2: 0};
let marks = {}; // Struktur: { 20: {1:0, 2:0}, ... }
let currentPlayer = initialPlayer;
let currentRound = 1;
let throwsLeft = 3;
let multiplier = 1;
let gameOver = false;
let history = []; 
let turnTotalPoints = 0;
let autoTurnTimer = null;

// --- AUDIO MAP ---
const audioMap = {
    // "180": "sounds/180.mp3"
};

function initGame() {
    scores = {1: 0, 2: 0};
    marks = {};
    cricketNums.forEach(n => marks[n] = {1: 0, 2: 0});

    currentPlayer = initialPlayer;
    currentRound = 1;
    document.getElementById('roundDisplay').textContent = "Runde: 1";

    throwsLeft = 3;
    multiplier = 1;
    gameOver = false;
    history = [];
    turnTotalPoints = 0;
    
    document.getElementById("winner").textContent = "";
    setMulti(1);
    updateUI();
    drawBoard();
}

function snapshot() {
    history.push(JSON.stringify({
        scores: {...scores},
        marks: JSON.parse(JSON.stringify(marks)),
        currentPlayer, throwsLeft, multiplier, gameOver,
        currentRound,
        turnTotalPoints
    }));
}

function undo() {
    if(!history.length) return;
    if(autoTurnTimer) clearTimeout(autoTurnTimer);
    
    const s = JSON.parse(history.pop());
    scores = s.scores;
    marks = s.marks;
    currentPlayer = s.currentPlayer;
    throwsLeft = s.throwsLeft;
    multiplier = s.multiplier;
    gameOver = s.gameOver;
    currentRound = s.currentRound || 1;
    turnTotalPoints = s.turnTotalPoints || 0;
    
    document.getElementById('roundDisplay').textContent = "Runde: " + currentRound;
    updateUI();
    drawBoard(); // Neu zeichnen um Markierungen zu aktualisieren
}

function setMulti(m) {
    if(gameOver) return; multiplier = m;
    ["single","double","triple"].forEach(id=>document.getElementById(id).classList.remove("active"));
    const btn = document.getElementById(m===1?"single":m===2?"double":"triple");
    if(btn) btn.classList.add("active");
}

function announce(text) {
    if (audioMap[text]) {
        let audio = new Audio(audioMap[text]);
        audio.play().catch(e => console.log("Audio play error", e));
    } else {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-GB'; 
            msg.rate = 1.1; 
            msg.pitch = 0.8;
            msg.volume = 1.0;
            let voices = window.speechSynthesis.getVoices();
            let gbVoice = voices.find(v => v.lang.includes('GB') || v.lang.includes('uk'));
            if (gbVoice) msg.voice = gbVoice;
            window.speechSynthesis.speak(msg);
        }
    }
}

function nextTurn() {
    if(gameOver) return;
    if(autoTurnTimer) clearTimeout(autoTurnTimer);

    snapshot();
    
    if(throwsLeft > 0) {
        if(turnTotalPoints > 0) announce(turnTotalPoints.toString());
        else announce("Next Player");
    }
    
    let nextP = currentPlayer === 1 ? 2 : 1;
    if (nextP === initialPlayer) {
        currentRound++;
        document.getElementById('roundDisplay').textContent = "Runde: " + currentRound;
    }
    
    currentPlayer = nextP;
    turnTotalPoints = 0;
    throwsLeft = 3;
    
    multiplier = 1; 
    setMulti(1); 
    updateUI();
}

function throwDart(num) {
    if(gameOver) return;
    // Cricket: Triple 25 geht nicht
    if(multiplier === 3 && num === 25) return;
    
    if(navigator.vibrate) navigator.vibrate(30);
    if(autoTurnTimer) clearTimeout(autoTurnTimer);

    snapshot();
    
    // Treffer Logik
    let pointsScored = 0;
    if (cricketNums.includes(num)) {
        let hits = multiplier;
        // Schleife f√ºr jeden "Teil" des Wurfs (wichtig wenn man w√§hrend eines Triples schlie√üt)
        for(let i=0; i<hits; i++) {
            let myMarks = marks[num][currentPlayer];
            let oppMarks = marks[num][currentPlayer === 1 ? 2 : 1];
            
            if (myMarks < 3) {
                // Schlie√üen
                marks[num][currentPlayer]++;
            } else {
                // Punkten (nur wenn Gegner noch nicht zu hat)
                if (oppMarks < 3) {
                    scores[currentPlayer] += num;
                    pointsScored += num;
                }
            }
        }
    }
    
    turnTotalPoints += pointsScored;
    
    if (pointsScored > 0) announce(pointsScored.toString());

    checkWin();
    if(gameOver) return;

    throwsLeft--;
    
    if(throwsLeft === 0) {
        if(turnTotalPoints > 0) announce(turnTotalPoints.toString());
        autoTurnTimer = setTimeout(nextTurn, 1000); 
    }
    
    multiplier = 1; setMulti(1);
    updateUI();
}

function checkWin() {
    let p1Closed = cricketNums.every(n => marks[n][1] >= 3);
    let p2Closed = cricketNums.every(n => marks[n][2] >= 3);
    
    let winner = null;
    
    if (p1Closed && scores[1] >= scores[2]) winner = 1;
    else if (p2Closed && scores[2] >= scores[1]) winner = 2;
    
    if (winner) {
        let winnerName = (winner === 1) ? name1 : name2;
        document.getElementById("winner").textContent = `üèÜ ${winnerName} GEWINNT!`;
        announce("Game Shot");
        
        gameOver = true;
        document.getElementById('game-border').className = "winner-glow";
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

        saveWin(winnerName);

        if(isTournament) {
            localStorage.setItem('tournament_winner_name', winnerName);
            setTimeout(() => { window.location.href = 'tournament.html'; }, 3000);
        }
    }
}

function saveWin(winnerName) {
    let stats = JSON.parse(localStorage.getItem('allTimeStats') || '{}');
    if (!stats[winnerName]) stats[winnerName] = { dart: 0, ttt: 0, x01: 0, cricket: 0 };
    if (typeof stats[winnerName] === 'number') stats[winnerName] = { dart: stats[winnerName], ttt: 0, x01: 0, cricket: 0 };
    stats[winnerName].cricket = (stats[winnerName].cricket || 0) + 1;
    localStorage.setItem('allTimeStats', JSON.stringify(stats));
}

function getMarkSymbol(count) {
    if (count === 0) return "&nbsp;";
    if (count === 1) return "/";
    if (count === 2) return "X";
    if (count >= 3) return "‚¶ª";
    return "";
}

function getMarkClass(count) {
    if (count === 0) return "";
    if (count === 1) return "s1";
    if (count === 2) return "s2";
    if (count >= 3) return "s3";
    return "";
}

function updateUI() {
    document.getElementById("score1").textContent = scores[1];
    document.getElementById("score2").textContent = scores[2];
    
    cricketNums.forEach(n => {
        let m1 = marks[n][1];
        let m2 = marks[n][2];
        
        let el1 = document.getElementById(`p1-${n}`);
        let el2 = document.getElementById(`p2-${n}`);
        
        el1.innerHTML = getMarkSymbol(m1);
        el1.className = "c-row mark " + getMarkClass(m1);
        
        el2.innerHTML = getMarkSymbol(m2);
        el2.className = "c-row mark " + getMarkClass(m2);
    });

    const side1 = document.getElementById("p1-side");
    const side2 = document.getElementById("p2-side");
    const border = document.getElementById('game-border');
    
    if(currentPlayer === 1) {
        side1.classList.add("active"); side2.classList.remove("active");
        if(!gameOver) border.className = "turn-p1";
    } else {
        side2.classList.add("active"); side1.classList.remove("active");
        if(!gameOver) border.className = "turn-p2";
    }
}

function drawBoard(){
    const svg = document.getElementById("dartboard");
    const defs = svg.querySelector("defs"); svg.innerHTML = ""; svg.appendChild(defs);
    order.forEach((n, i) => {
        // Logik f√ºr Board Dimming
        let isCricket = cricketNums.includes(n);
        let opacity = isCricket ? "1" : "0.15";
        let color = "#2a2a2a";

        const a1 = ((i * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const a2 = (((i + 1) * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const x1=BOARD_R*Math.cos(a1), y1=BOARD_R*Math.sin(a1), x2=BOARD_R*Math.cos(a2), y2=BOARD_R*Math.sin(a2);
        
        const bg = document.createElementNS("http://www.w3.org/2000/svg","path");
        bg.setAttribute("d",`M0,0 L${x1},${y1} A${BOARD_R},${BOARD_R} 0 0,1 ${x2},${y2} Z`);
        bg.setAttribute("fill", color); bg.setAttribute("stroke","#000"); 
        bg.style.opacity = opacity;
        svg.appendChild(bg);
        
        const lx = (BOARD_R + 35) * Math.cos((a1+a2)/2), ly = (BOARD_R + 35) * Math.sin((a1+a2)/2);
        const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
        txt.setAttribute("x", lx); txt.setAttribute("y", ly);
        txt.setAttribute("text-anchor","middle"); txt.setAttribute("alignment-baseline","middle");
        txt.setAttribute("fill", isCricket ? "#fff" : "#444"); 
        txt.setAttribute("font-weight", "bold");
        txt.textContent = n; svg.appendChild(txt);

        const click = document.createElementNS("http://www.w3.org/2000/svg","path");
        click.setAttribute("d",`M0,0 L${x1},${y1} A${BOARD_R},${BOARD_R} 0 0,1 ${x2},${y2} Z`);
        click.setAttribute("fill","transparent"); click.style.cursor="pointer";
        click.onclick = () => throwDart(n); svg.appendChild(click);
    });
    const bBg = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bBg.setAttribute("r", BULL_R); bBg.setAttribute("fill", "#2a2a2a"); bBg.setAttribute("stroke","#000"); svg.appendChild(bBg);
    const bClick = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bClick.setAttribute("r", BULL_R); bClick.setAttribute("fill","transparent");
    bClick.style.cursor="pointer"; bClick.onclick = () => throwDart(25); svg.appendChild(bClick);
}

function confirmReset() { if (confirm("Reset?")) resetGame(); }
function resetGame(){ initGame(); }

async function requestWakeLock() { if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (err) {} } }
document.addEventListener('click', requestWakeLock, { once: true });

if ('speechSynthesis' in window) {
    window.speechSynthesis.getVoices();
}

initGame();
</script>
</body>
</html>
