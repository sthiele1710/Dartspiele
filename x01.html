<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>X01 Darts</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
    body { 
        margin:0; font-family: system-ui, sans-serif; background:#1a1a1a; color:white; text-align:center; 
        overflow: hidden; touch-action: manipulation; padding-bottom: 0; height: 100vh; display: flex; flex-direction: column;
    }

    #game-border {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
        box-sizing: border-box; border: 0px solid transparent; transition: box-shadow 0.8s ease-in-out, border-color 0.8s ease-in-out;
    }
    #game-border.turn-p1 { box-shadow: inset 0 0 50px rgba(255, 59, 59, 0.4); border: 4px solid rgba(255, 59, 59, 0.5); }
    #game-border.turn-p2 { box-shadow: inset 0 0 50px rgba(0, 191, 255, 0.4); border: 4px solid rgba(0, 191, 255, 0.5); }
    #game-border.winner-glow { box-shadow: inset 0 0 80px rgba(255, 215, 0, 0.6); border: 6px solid gold; }

    /* --- HEADER --- */
    .top-bar { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; margin-bottom: 5px; }
    .mode-select select { background: #333; color: white; border: 1px solid #555; padding: 4px 8px; border-radius: 5px; font-size: 16px; }
    h1 { margin: 0; color: gold; font-size: 22px; line-height: 1; }
    #seriesInfo { font-size: 14px; color: #888; font-weight: bold; margin-top: 5px;}
    #roundDisplay { font-size: 16px; color: #aaa; font-weight: bold; margin-bottom: 10px;}

    /* --- SCOREBOARD --- */
    .scoreboard { display: flex; justify-content: space-around; margin: 0 0 10px 0; align-items: flex-start; }
    
    .player-score { 
        display: flex; flex-direction: column; width: 42%; 
        padding: 12px 8px; 
        border-radius: 12px; transition: 0.3s; position: relative; 
    }
    .player-score.active { background: #333; transform: scale(1.03); border: 2px solid gold; z-index: 10; }
    
    .p-name { font-size: 18px; font-weight: bold; margin-bottom: 8px; line-height: 1.1; opacity: 0.9; }
    
    .p-points { 
        font-size: 56px; 
        font-weight: 800; line-height: 1; 
        margin-bottom: 4px; 
        z-index: 2; position: relative;
    }
    
    .avg-display { 
        font-size: 13px; color: #aaa; font-weight: bold; z-index: 1;
        margin-bottom: 8px; 
    }

    .info-wrapper { 
        display: flex; flex-direction: column; justify-content: flex-start;
        margin-top: 0; 
    }
    
    /* Checkout Hinweis (wieder entfernt/versteckt wie gew√ºnscht, Platzhalter bleibt klein) */
    .checkout-hint { 
        display: none; /* Ausgeblendet f√ºr Platz */
    }

    .mini-throws {
        display: flex; justify-content: center; gap: 4px; 
        margin-top: 0; 
        min-height: 24px;
    }
    .throw-tag {
        font-size: 13px; font-weight: bold; color: gold; background: #222; 
        padding: 2px 6px; border-radius: 4px; border: 1px solid #444; line-height: 1.2;
    }

    .p1 .p-name { color: #ff3b3b; }
    .p2 .p-name { color: #00bfff; }

    /* --- CONTROLS --- */
    #controls { max-width:440px; margin: 0 auto; padding: 0 10px; width: 100%; box-sizing: border-box; }
    .btn-row { display:flex; justify-content:center; gap:8px; margin-bottom:10px; }
    button { padding: 12px; font-size:15px; border-radius:8px; border:none; cursor:pointer; flex:1; background: #444; color: white; transition: 0.1s; user-select: none; }
    button.active { background: gold; color: black; font-weight:bold; }
    button.func { background: #555; padding: 10px; font-size: 13px; }
    
    /* --- BOARD --- */
    #board-container { 
        flex-grow: 1; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        min-height: 0; 
        padding-bottom: 10px;
        padding: 0;
        width: 100%;
        overflow: hidden;
    }
    
    #next-turn-container { width: 100%; max-width:440px; margin: 0 auto 10px auto; padding: 0 10px; box-sizing: border-box; }
    button.next-turn { background: #2e7d32; color: white; width: 100%; font-weight: bold; font-size: 18px; border: 1px solid #4caf50; padding: 15px; border-radius: 10px;}
    
    #winner { font-size:32px; margin:15px 0; font-weight:bold; color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.5); position:absolute; top: 40%; left:0; width:100%; z-index:100; pointer-events:none;}
</style>
</head>
<body>

<div id="game-border"></div>

<div class="top-bar">
    <h1 id="mainTitle">üéØ X01</h1>
    <div id="modeContainer" class="mode-select">
        <select id="startScoreSelect" onchange="resetGame()">
            <option value="301">301</option>
            <option value="501" selected>501</option>
        </select>
    </div>
</div>
<div id="seriesInfo"></div>
<div id="roundDisplay">Runde: 1</div>

<div class="scoreboard">
    <div id="p1-box" class="player-score p1 active">
        <div class="p-name" id="name1">Spieler 1</div>
        <div class="p-points" id="score1">501</div>
        <div class="avg-display" id="avg1">√ò 0.0</div>
        
        <div class="info-wrapper">
            <div class="mini-throws" id="throws1"></div>
        </div>
    </div>
    <div id="p2-box" class="player-score p2">
        <div class="p-name" id="name2">Spieler 2</div>
        <div class="p-points" id="score2">501</div>
        <div class="avg-display" id="avg2">√ò 0.0</div>
        
        <div class="info-wrapper">
            <div class="mini-throws" id="throws2"></div>
        </div>
    </div>
</div>

<div id="controls">
  <div class="btn-row">
    <button id="single" class="active" onclick="setMulti(1)">Single</button>
    <button id="double" onclick="setMulti(2)">Double</button>
    <button id="triple" onclick="setMulti(3)">Triple</button>
  </div>
  <div class="btn-row">
    <button class="func" onclick="undo()">‚Ü©Ô∏è Undo</button>
    <button class="func" onclick="confirmReset()">üîÑ Reset</button>
    <button class="func" id="homeBtn" onclick="location.href='index.html'">üè† Home</button>
  </div>
</div>

<div id="winner"></div>

<div id="board-container">
    <svg viewBox="-225 -225 450 450" id="dartboard">
        <defs><pattern id="hatch" patternUnits="userSpaceOnUse" width="10" height="10" patternTransform="rotate(45)"><rect width="5" height="10" fill="rgba(255,59,59,0.7)" /><rect x="5" width="5" height="10" fill="rgba(0,191,255,0.7)" /></pattern></defs>
    </svg>
</div>

<div id="next-turn-container">
    <button class="next-turn" onclick="nextTurn()">‚è≠Ô∏è Zug beenden / Verfehlt</button>
</div>

<script>
// --- CONFIG & SETUP ---
const order=[20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
const ROTATION_OFFSET = -9;
const BOARD_R = 180;
const BULL_R = 38;

const urlParams = new URLSearchParams(window.location.search);
const isTournament = urlParams.get('tournament') === 'true';
const startParam = urlParams.get('starter');
const initialPlayer = startParam ? parseInt(startParam) : 1;

let startScore = 501;

let name1, name2;
if (isTournament) {
    name1 = localStorage.getItem('tournament_p1') || "T1";
    name2 = localStorage.getItem('tournament_p2') || "T2";
    document.getElementById('homeBtn').style.display = 'none';
    document.getElementById('modeContainer').style.display = 'none';
    document.getElementById('mainTitle').style.display = 'none';
    
    let s1 = urlParams.get('s1');
    let s2 = urlParams.get('s2');
    let target = urlParams.get('target');
    if(s1 !== null) {
        document.getElementById('seriesInfo').innerHTML = `Serie: <span style="color:#ff3b3b">${s1}</span> - <span style="color:#00bfff">${s2}</span> (First to ${target})`;
    }
} else {
    name1 = localStorage.getItem('dart_p1') || "Spieler 1";
    name2 = localStorage.getItem('dart_p2') || "Spieler 2";
}

document.getElementById('name1').textContent = name1;
document.getElementById('name2').textContent = name2;

let scores = {1: 501, 2: 501};
let startOfTurnScore = {1: 501, 2: 501};
let stats = { 1: { throws: 0, points: 0 }, 2: { throws: 0, points: 0 } };

let currentPlayer = initialPlayer;
let currentRound = 1;
let throwsLeft = 3;
let multiplier = 1;
let gameOver = false;
let history = []; 
let turnTotalPoints = 0;
let roundThrows = { 1: [], 2: [] }; 
let autoTurnTimer = null; // Timer f√ºr automatischen Wechsel

// --- AUDIO MAP ---
const audioMap = {
    // "180": "sounds/180.mp3"
};

function initGame() {
    if(!isTournament) startScore = parseInt(document.getElementById('startScoreSelect').value);
    
    scores = {1: startScore, 2: startScore};
    startOfTurnScore = {1: startScore, 2: startScore};
    stats = { 1: { throws: 0, points: 0 }, 2: { throws: 0, points: 0 } };

    currentPlayer = initialPlayer;
    currentRound = 1;
    document.getElementById('roundDisplay').textContent = "Runde: 1";

    throwsLeft = 3;
    multiplier = 1;
    gameOver = false;
    history = [];
    roundThrows = { 1: [], 2: [] }; 
    turnTotalPoints = 0;
    
    document.getElementById("winner").textContent = "";
    setMulti(1);
    updateUI();
    drawBoard();
}

function snapshot() {
    history.push(JSON.stringify({
        scores: {...scores},
        startOfTurnScore: {...startOfTurnScore},
        stats: JSON.parse(JSON.stringify(stats)),
        currentPlayer, throwsLeft, multiplier, gameOver,
        roundThrows: JSON.parse(JSON.stringify(roundThrows)),
        currentRound,
        turnTotalPoints
    }));
}

function undo() {
    if(!history.length) return;
    // Timer abbrechen falls aktiv
    if(autoTurnTimer) clearTimeout(autoTurnTimer);
    
    const s = JSON.parse(history.pop());
    scores = s.scores;
    startOfTurnScore = s.startOfTurnScore;
    stats = s.stats;
    currentPlayer = s.currentPlayer;
    throwsLeft = s.throwsLeft;
    multiplier = s.multiplier;
    gameOver = s.gameOver;
    roundThrows = s.roundThrows;
    currentRound = s.currentRound || 1;
    turnTotalPoints = s.turnTotalPoints || 0;
    
    document.getElementById('roundDisplay').textContent = "Runde: " + currentRound;
    updateUI();
}

function setMulti(m) {
    if(gameOver) return; multiplier = m;
    ["single","double","triple"].forEach(id=>document.getElementById(id).classList.remove("active"));
    const btn = document.getElementById(m===1?"single":m===2?"double":"triple");
    if(btn) btn.classList.add("active");
}

function formatThrow(m, n) {
    if (n === 25) return m === 2 ? "D25" : "25";
    if (m === 3) return "T" + n;
    if (m === 2) return "D" + n;
    return n.toString();
}

function announce(text) {
    if (audioMap[text]) {
        let audio = new Audio(audioMap[text]);
        audio.play().catch(e => console.log("Audio play error", e));
    } else {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            let msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-GB'; 
            msg.rate = 1.1; 
            msg.pitch = 0.8;
            msg.volume = 1.0;
            let voices = window.speechSynthesis.getVoices();
            let gbVoice = voices.find(v => v.lang.includes('GB') || v.lang.includes('uk'));
            if (gbVoice) msg.voice = gbVoice;
            window.speechSynthesis.speak(msg);
        }
    }
}

function nextTurn() {
    if(gameOver) return;
    
    // Timer l√∂schen (falls Button geklickt wurde bevor Timer abgelaufen ist)
    if(autoTurnTimer) clearTimeout(autoTurnTimer);

    snapshot();
    
    // --- AUDIO AUSGABE ---
    // Wenn 3 W√ºrfe gemacht wurden, wurde es schon in throwDart angesagt.
    // Wenn throwsLeft > 0, bedeutet es, dass der User "Abbrechen" gedr√ºckt hat
    // oder daneben geworfen hat.
    if(throwsLeft > 0) {
        if(turnTotalPoints > 0) {
            announce(turnTotalPoints.toString());
        } else {
            announce("No Score");
        }
    }
    
    let nextP = currentPlayer === 1 ? 2 : 1;
    if (nextP === initialPlayer) {
        currentRound++;
        document.getElementById('roundDisplay').textContent = "Runde: " + currentRound;
    }
    
    currentPlayer = nextP;
    
    // Nur die W√ºrfe des neuen Spielers l√∂schen
    roundThrows[currentPlayer] = [];
    turnTotalPoints = 0;

    throwsLeft = 3;
    startOfTurnScore[currentPlayer] = scores[currentPlayer];
    
    multiplier = 1; 
    setMulti(1); 
    updateUI();
}

function throwDart(num) {
    if(gameOver) return;
    if(multiplier === 3 && num === 25) return;
    if(navigator.vibrate) navigator.vibrate(30);
    
    // Timer abbrechen falls aktiv (schnelle Eingabe)
    if(autoTurnTimer) clearTimeout(autoTurnTimer);

    snapshot();
    
    const points = num * multiplier;
    let newScore = scores[currentPlayer] - points;
    
    roundThrows[currentPlayer].push(formatThrow(multiplier, num));
    turnTotalPoints += points;

    stats[currentPlayer].throws++;
    stats[currentPlayer].points += points;

    if (newScore === 0) {
        scores[currentPlayer] = 0;
        checkWin();
    } else if (newScore < 0 || newScore === 1) { 
        announce("No Score"); 
        scores[currentPlayer] = startOfTurnScore[currentPlayer]; 
        throwsLeft = 1; 
        turnTotalPoints = 0; 
    } else {
        scores[currentPlayer] = newScore;
    }

    throwsLeft--;
    
    if(throwsLeft === 0 && !gameOver) {
        // AUTOMATISCHE ANSAGE NACH 3 W√úRFEN
        if(newScore > 1) { 
             announce(turnTotalPoints.toString());
        }
        // Automatischer Wechsel verz√∂gert
        autoTurnTimer = setTimeout(nextTurn, 1000); 
    } else {
        multiplier = 1; setMulti(1);
        updateUI();
    }
}

function checkWin() {
    let winnerName = (currentPlayer === 1) ? name1 : name2;
    document.getElementById("winner").textContent = `üèÜ ${winnerName} CHECKOUT!`;
    document.getElementById("score" + currentPlayer).textContent = "0";
    
    announce("Game Shot");
    
    gameOver = true;
    document.getElementById('game-border').className = "winner-glow";
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

    saveWin(winnerName);

    if(isTournament) {
        localStorage.setItem('tournament_winner_name', winnerName);
        setTimeout(() => { window.location.href = 'tournament.html'; }, 3000);
        return;
    }
    updateUI();
}

function saveWin(winnerName) {
    let stats = JSON.parse(localStorage.getItem('allTimeStats') || '{}');
    if (!stats[winnerName]) stats[winnerName] = { dart: 0, ttt: 0, x01: 0 };
    if (typeof stats[winnerName] === 'number') stats[winnerName] = { dart: stats[winnerName], ttt: 0, x01: 0 };
    stats[winnerName].x01 = (stats[winnerName].x01 || 0) + 1;
    localStorage.setItem('allTimeStats', JSON.stringify(stats));
}

function updateUI() {
    document.getElementById("score1").textContent = scores[1];
    document.getElementById("score2").textContent = scores[2];
    
    let avg1 = stats[1].throws > 0 ? (stats[1].points / stats[1].throws * 3).toFixed(1) : "0.0";
    let avg2 = stats[2].throws > 0 ? (stats[2].points / stats[2].throws * 3).toFixed(1) : "0.0";
    document.getElementById("avg1").textContent = "√ò " + avg1;
    document.getElementById("avg2").textContent = "√ò " + avg2;

    const p1Box = document.getElementById("p1-box");
    const p2Box = document.getElementById("p2-box");
    const border = document.getElementById('game-border');
    
    document.getElementById('throws1').innerHTML = "";
    document.getElementById('throws2').innerHTML = "";

    roundThrows[1].forEach(t => {
        let tag = document.createElement("span");
        tag.className = "throw-tag";
        tag.textContent = t;
        document.getElementById('throws1').appendChild(tag);
    });

    roundThrows[2].forEach(t => {
        let tag = document.createElement("span");
        tag.className = "throw-tag";
        tag.textContent = t;
        document.getElementById('throws2').appendChild(tag);
    });

    if(currentPlayer === 1) {
        p1Box.classList.add("active"); p2Box.classList.remove("active");
        if(!gameOver) border.className = "turn-p1";
    } else {
        p2Box.classList.add("active"); p1Box.classList.remove("active");
        if(!gameOver) border.className = "turn-p2";
    }
}

function drawBoard(){
    const svg = document.getElementById("dartboard");
    const defs = svg.querySelector("defs"); svg.innerHTML = ""; svg.appendChild(defs);
    order.forEach((n, i) => {
        const a1 = ((i * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const a2 = (((i + 1) * 18 + ROTATION_OFFSET) - 90) * Math.PI / 180;
        const x1=BOARD_R*Math.cos(a1), y1=BOARD_R*Math.sin(a1), x2=BOARD_R*Math.cos(a2), y2=BOARD_R*Math.sin(a2);
        const bg = document.createElementNS("http://www.w3.org/2000/svg","path");
        bg.setAttribute("d",`M0,0 L${x1},${y1} A${BOARD_R},${BOARD_R} 0 0,1 ${x2},${y2} Z`);
        bg.setAttribute("fill","#2a2a2a"); bg.setAttribute("stroke","#000"); svg.appendChild(bg);
        
        const lx = (BOARD_R + 35) * Math.cos((a1+a2)/2), ly = (BOARD_R + 35) * Math.sin((a1+a2)/2);
        const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
        txt.setAttribute("x", lx); txt.setAttribute("y", ly);
        txt.setAttribute("text-anchor","middle"); txt.setAttribute("alignment-baseline","middle");
        txt.setAttribute("fill", "#666"); txt.setAttribute("font-weight", "bold");
        txt.textContent = n; svg.appendChild(txt);

        const click = document.createElementNS("http://www.w3.org/2000/svg","path");
        click.setAttribute("d",`M0,0 L${x1},${y1} A${BOARD_R},${BOARD_R} 0 0,1 ${x2},${y2} Z`);
        click.setAttribute("fill","transparent"); click.style.cursor="pointer";
        click.onclick = () => throwDart(n); svg.appendChild(click);
    });
    const bBg = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bBg.setAttribute("r", BULL_R); bBg.setAttribute("fill", "#2a2a2a"); bBg.setAttribute("stroke","#000"); svg.appendChild(bBg);
    const bClick = document.createElementNS("http://www.w3.org/2000/svg","circle");
    bClick.setAttribute("r", BULL_R); bClick.setAttribute("fill","transparent");
    bClick.style.cursor="pointer"; bClick.onclick = () => throwDart(25); svg.appendChild(bClick);
}

function confirmReset() { if (confirm("Reset?")) resetGame(); }
function resetGame(){ initGame(); }

async function requestWakeLock() { if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (err) {} } }
document.addEventListener('click', requestWakeLock, { once: true });

if ('speechSynthesis' in window) {
    window.speechSynthesis.getVoices();
}

initGame();
</script>
</body>
</html>
